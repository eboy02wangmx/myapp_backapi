<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC
    "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="jp.co.myapp.api.domain.repository.receptionsearch.ReceptionSearchRepository">

	<select id="findCount" parameterType="jp.co.myapp.api.app.request.ReceptionSearchRequest" resultType="int">
    <![CDATA[
        SELECT
        	count(1) AS cnt
        FROM
            CHG_REQEST
        WHERE
  			1 = 1
	   	]]><include refid="searchConditions"/>
	</select>

    <select id="findAll" parameterType="jp.co.myapp.api.app.request.ReceptionSearchRequest" resultMap="getListMap">
    <![CDATA[
    	SELECT
    		no,
            ]]><include refid="chgReqestALLColumn"/><![CDATA[
    	FROM (
	    	SELECT
	            ]]><include refid="chgReqestALLColumn"/><![CDATA[
				,ROW_NUMBER() OVER(ORDER BY uke_ymd DESC, uke_time DESC, TO_NUMBER(acceptance_no)) AS no
	        FROM
	            CHG_REQEST
	        WHERE
	        	1 = 1
	    	]]><include refid="searchConditions"/><![CDATA[
        	) T1
        WHERE
        	no BETWEEN #{rownoStart} AND #{rownoEnd}
    ]]>
    </select>

    <select id="findCSVList" parameterType="jp.co.myapp.api.app.request.ReceptionSearchRequest" resultType="jp.co.myapp.api.domain.model.ReceptionCSVBean">
    <![CDATA[
    	SELECT
            ]]><include refid="chgReqestALLColumn"/><![CDATA[
        FROM
            CHG_REQEST
        WHERE
        	1 = 1
    	]]><include refid="searchConditions"/>
    	ORDER BY
    		uke_ymd DESC,
    		uke_time DESC,
    		TO_NUMBER(acceptance_no)
    </select>

	<resultMap id="getListMap" type="ReceptionSearchBean">
		<id property="no" column="no"></id>
		<id property="changeReceptionNo" column="acceptance_no"></id>
		<result property="policyNo" column="policy" ></result>
		<result property="contractorName" column="name_keiyaku"></result>
		<result property="contractorNameKana" column="name_keiyaku_k"></result>
		<result property="salesCode" column="katen_cd"></result>
		<result property="agentCode" column="dairi_cd"></result>
		<result property="receptionDate" column="uke_ymd"></result>
		<result property="receptionTime" column="uke_time"></result>
		<result property="changeDesiredDate" column="henko_kibou_ymd"></result>
		<result property="changeType" column="henko_kbn"></result>
		<result property="agreeType" column="keiyaku_kbn"></result>
		<result property="startDate" column="siki_date"></result>
		<result property="endDate" column="syuuki_date"></result>
		<result property="contactTimeZoneMorning" column="tel_hour_am"></result>
		<result property="contactTimeZoneNoon" column="tel_hour_12_14"></result>
		<result property="contactTimeZoneAfternooon" column="tel_hour_14_17"></result>
		<result property="contactTimeZoneNone" column="tel_hour_none"></result>
		<result property="contactTelArea" column="tel_renraku_area"></result>
		<result property="contactTelCity" column="tel_renraku_city"></result>
		<result property="contactTelNo" column="tel_renraku_number"></result>
		<result property="contactCode" column="tel_cd"></result>
		<result property="reason1" column="jiyuu_1"></result>
		<result property="reason2" column="jiyuu_2"></result>
		<result property="reason3" column="jiyuu_3"></result>
		<result property="reason4" column="jiyuu_4"></result>
		<result property="reason5" column="jiyuu_5"></result>
		<result property="reason6" column="jiyuu_6"></result>
		<result property="oldMailAddress" column="mail_address_old"></result>
		<result property="newMailAddress" column="mail_address_new"></result>
		<result property="confirmedFlag" column="kakunin_flg"></result>
		<result property="deleteFlag" column="del_flg"></result>
		<result property="updateTime" column="upd_date"></result>
		<result property="createTime" column="add_date"></result>
	</resultMap>

    <sql id="searchConditions">
    	<!-- 変更受付番号 -->
    	<if test="henkouketsukeStartYmd != null and henkouketsukeStartYmd != ''"><![CDATA[
			AND TO_NUMBER(acceptance_no) >= #{henkouketsukeStartYmd}]]></if>
		<if test="henkouketsukeEndYmd != null and henkouketsukeEndYmd != ''"><![CDATA[
			AND TO_NUMBER(acceptance_no) <= #{henkouketsukeEndYmd}]]></if>
		<!-- 証券番号 -->
    	<if test="policy != null and policy != ''"><![CDATA[
			AND policy = #{policy}]]></if>
		<!-- 契約者氏名カナ -->
		<if test="keiyakuNameKana != null and keiyakuNameKana != ''">
		<bind name="toKeiyakuNameKana" value="@org.terasoluna.gfw.common.query.QueryEscapeUtils@toContainingCondition(keiyakuNameKana)" /><![CDATA[
			AND name_keiyaku_k like #{toKeiyakuNameKana} ESCAPE '~']]></if>
		<!-- 営業課店コード -->
		<if test="eigyoKatenCd != null and eigyoKatenCd != ''"><![CDATA[
			AND katen_cd = #{eigyoKatenCd}]]></if>
		<!-- 代理店コード -->
		<if test="dairitenCd != null and dairitenCd.length != 0"><![CDATA[
            AND TRIM(dairi_cd) IN ]]><foreach collection="dairitenCd" item="item" open="(" separator="," close=")">#{item}</foreach></if>
        <!-- 受付日 -->
		<if test="uketsukeStartYmd != null and uketsukeStartYmd != ''"><![CDATA[
			AND uke_ymd >= #{uketsukeStartYmd}]]></if>
		<if test="uketsukeEndEnd != null and uketsukeEndEnd != ''"><![CDATA[
			AND uke_ymd <= #{uketsukeEndEnd}]]></if>
        <!-- 変更希望日 -->
		<if test="kibouStartYmd != null and kibouStartYmd != ''"><![CDATA[
			AND henko_kibou_ymd >= #{kibouStartYmd}]]></if>
		<if test="koboEndYmd != null and koboEndYmd != ''"><![CDATA[
			AND henko_kibou_ymd <= #{koboEndYmd}]]></if>
		<!-- 変更区分 -->
		<if test="changeType != null and changeType.length != 0"><![CDATA[
			AND henko_kbn IN ]]><foreach collection="changeType" item="item" open="(" separator="," close=")">#{item}</foreach></if>
		<!-- 契約区分 -->
		<if test="agreeType != null and agreeType.length != 0"><![CDATA[
			AND keiyaku_kbn IN ]]><foreach collection="agreeType" item="item" open="(" separator="," close=")">#{item}</foreach></if>
		<!-- 連絡時間帯 -->
		<if test="(renrakuNone != null and renrakuNone != '') or (renrakuAM != null and renrakuAM != '') or (renraku12 != null and renraku12 != '') or (renraku14 != null and renraku14 != '')"><![CDATA[
			AND ((1 <> 1)]]>
			<!-- 連絡時間帯（午前） -->
			<if test="renrakuAM != null and renrakuAM != ''"><![CDATA[
				OR (tel_hour_am = #{renrakuAM})]]></if>
			<!-- 連絡時間帯（12時-14時） -->
			<if test="renraku12 != null and renraku12 != ''"><![CDATA[
				OR (tel_hour_12_14 = #{renraku12})]]></if>
			<!-- 連絡時間帯（14時-17時） -->
			<if test="renraku14 != null and renraku14 != ''"><![CDATA[
				OR (tel_hour_14_17 = #{renraku14})]]></if>
			<!-- 連絡時間帯（指定なし） -->
			<if test="renrakuNone != null and renrakuNone != ''"><![CDATA[
				OR (tel_hour_none = #{renrakuNone})]]></if>
			<![CDATA[
			)]]></if>
		<!-- 確認済フラグ -->
		<if test="receptionConfirmSituation != null and receptionConfirmSituation.length != 0"><![CDATA[
			AND kakunin_flg IN ]]><foreach collection="receptionConfirmSituation" item="item" open="(" separator="," close=")">#{item}</foreach></if>
		<!-- 削除フラグ -->
		<![CDATA[
			AND del_flg = '0']]>
	</sql>

	<sql id="chgReqestALLColumn">
    <![CDATA[acceptance_no,
			policy,
			name_keiyaku,
			name_keiyaku_k,
			katen_cd,
			TRIM(dairi_cd) AS dairi_cd,
			uke_ymd,
			uke_time,
			henko_kibou_ymd,
			henko_kbn,
			keiyaku_kbn,
			siki_date,
			syuuki_date,
			tel_hour_am,
			tel_hour_12_14,
			tel_hour_14_17,
			tel_hour_none,
			tel_renraku_area,
			tel_renraku_city,
			tel_renraku_number,
			tel_cd,
			jiyuu_1,
			jiyuu_2,
			jiyuu_3,
			jiyuu_4,
			jiyuu_5,
			jiyuu_6,
			mail_address_old,
			mail_address_new,
			kakunin_flg,
			del_flg,
			upd_date,
			add_date
	]]>
	</sql>

</mapper>
